import os
from fabric.api import *

env.roledefs = {
    'web': [
        'ttforbes.com'
    ],
}


env.user = "matt"
env.project_dir = '/usr/django/dontmiss/'
env.activate = 'source %s' % os.path.join(env.project_dir, 'ably/bin/activate')

@roles('web')
def update_env():
    with cd(project_dir):
        run('git stash')
        run('git pull origin master')
        sudo('pip install -E orchard -r ./requirements.txt')
        #sudo('pip install -E orchard -r ./scipy_requirement.txt')
        sudo('pip install -E orchard -r ./post_scipy_requirements.txt')

@roles('web')
def update_django():
    """ Updates the remote django project.
    """
    with cd(freshplum_path):
        run('git stash')
        run('git pull origin master')
        run('git submodule init')
        run('git submodule update')

@roles('web')
def restart_webserver():
    """ Restarts remote nginx and uwsgi.
    """
    with prefix('source %s/orchard/bin/activate' % freshenv_path):
        sudo('service uwsgi restart')
        sudo('/etc/init.d/nginx restart')

def deploy():
    """ Deploy Django Project.
    """
    execute(update_env)
    execute(update_django)
    execute(restart_webserver)
